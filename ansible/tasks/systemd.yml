- name: Create /etc/sysconfig/opa
  ansible.builtin.copy:
    dest: /etc/sysconfig/opa
    owner: root
    group: root
    mode: '0644'
    force: no
    content: |
      PORT={{ opa_port }}
      CERT_FILE={{ opa_cert_file }}
      KEY_FILE={{ opa_key_file }}
      CONFIG_FILE={{ opa_config_file }}
      LOG_PATH={{ opa_log_path }}
      LOG_LEVEL={{ opa_log_level }}
      LOG_FORMAT={{ opa_log_format }}
  notify: Restart OPA

- name: Ensure log directory exists
  ansible.builtin.file:
    path: "{{ opa_log_path }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create OPA systemd service
  ansible.builtin.copy:
    dest: /etc/systemd/system/opa.service
    owner: root
    group: root
    mode: '0644'
    content: |
      [Unit]
      Description=Open Policy Agent
      After=network.target

      [Service]
      Type=simple
      EnvironmentFile=/etc/sysconfig/opa
      ExecStart=/usr/bin/opa run -s -c ${CONFIG_FILE} \
        --addr https://0.0.0.0:${PORT} \
        --authentication=token \
        --authorization=basic \
        --tls-cert-file ${CERT_FILE} \
        --tls-private-key-file ${KEY_FILE} \
        --log-level ${LOG_LEVEL} \
        --log-format ${LOG_FORMAT}
      StandardOutput=append:{{ opa_log_path }}/error.log
      StandardError=append:{{ opa_log_path }}/access.log
      Restart=always
      RestartSec=5
      User=root

      [Install]
      WantedBy=multi-user.target
  notify: Reload systemd

- name: Enable and start OPA service
  ansible.builtin.systemd:
    name: opa
    enabled: yes
    state: started
